Changes in module 'nf-core/samtools/sort'
--- modules/nf-core/samtools/sort/main.nf
+++ modules/nf-core/samtools/sort/main.nf
@@ -8,12 +8,14 @@
         'biocontainers/samtools:1.19.2--h50ea8bc_0' }"
 
     input:
-    tuple val(meta), path(bam)
+    tuple val(meta), path(input), path(fasta)
 
     output:
-    tuple val(meta), path("*.bam"), emit: bam
-    tuple val(meta), path("*.csi"), emit: csi, optional: true
-    path  "versions.yml"          , emit: versions
+    tuple val(meta), path("*.bam")        , emit: bam,    optional: true
+    tuple val(meta), path("*.cram")       , emit: cram,   optional: true
+    tuple val(meta), path("*.crai")       , emit: crai,   optional: true
+    tuple val(meta), path("*.csi")        , emit: csi,    optional: true
+    path "versions.yml"                   , emit: versions
 
     when:
     task.ext.when == null || task.ext.when
@@ -21,14 +23,26 @@
     script:
     def args = task.ext.args ?: ''
     def prefix = task.ext.prefix ?: "${meta.id}"
-    if ("$bam" == "${prefix}.bam") error "Input and output names are the same, use \"task.ext.prefix\" to disambiguate!"
+    def extension = args.contains("--output-fmt sam") ? "sam" :
+                    args.contains("--output-fmt bam") ? "bam" :
+                    args.contains("--output-fmt cram") ? "cram" :
+                    "bam"
+    def reference = fasta ? "--reference ${fasta}" : ""
+    def sort_memory = (task.memory.mega/task.cpus*0.75).intValue()
+
     """
+    samtools cat \\
+        --threads $task.cpus \\
+        ${input}  \\
+    | \\
     samtools sort \\
         $args \\
-        -@ $task.cpus \\
-        -o ${prefix}.bam \\
-        -T $prefix \\
-        $bam
+        -T ${prefix} \\
+        --threads $task.cpus \\
+        --reference ${fasta} \\
+        -m ${sort_memory}M \\
+        -o ${prefix}.${extension} \\
+        -
 
     cat <<-END_VERSIONS > versions.yml
     "${task.process}":
@@ -40,6 +54,7 @@
     def prefix = task.ext.prefix ?: "${meta.id}"
     """
     touch ${prefix}.bam
+    touch ${prefix}.bam.csi
 
     cat <<-END_VERSIONS > versions.yml
     "${task.process}":

************************************************************
